name: Daily RSS Digest + Social Content

on:
  schedule:
    - cron: '0 12 * * *'  # UTC 12:00 = åŒ—äº¬æ—¶é—´ 20:00
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  digest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --no-cache-dir feedparser google-genai pillow playwright
          python -m playwright install chromium

      - name: Fetch and translate feeds
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          AI_PROVIDER: gemini
        run: python fetch_feeds.py

      - name: Generate social content (top 5)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python generate_social.py batch --top 5

      - name: Commit all content
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add digest-*.md social/
          git diff --staged --quiet || git commit -m "Daily digest + social content $(date +%Y-%m-%d)"
          git push

      - name: Create review Issue
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh label create "review-needed" --description "Social content ready for review" --color "FFA500" || true
          DATE=$(date +%Y-%m-%d)
          DIGEST="digest-${DATE}.md"

          # Build issue body
          BODY="## ğŸ“‹ ä»Šæ—¥ç¤¾äº¤å†…å®¹å·²ç”Ÿæˆ\n\n"
          BODY+="**æ—¥æœŸ**: ${DATE}\n\n"

          if [ -f "social/tracking.json" ]; then
            BODY+="### å·²ç”Ÿæˆè¯é¢˜\n\n"
            BODY+=$(python3 -c "
import json
t=json.loads(open('social/tracking.json').read())
for dk in sorted(t.keys(), reverse=True)[:1]:
  for k,v in sorted(t[dk].get('generated',{}).items(), key=lambda x:int(x[0])):
    print(f'- **#{k}** {v[\"title\"]}')
")
            BODY+="\n\n### æ“ä½œ\n\n"
            BODY+="è¯·å®¡æ ¸åå›å¤éœ€è¦å‘å¸ƒçš„è¯é¢˜ç¼–å·ï¼Œå¦‚: \`å‘å¸ƒ 1 3 5\`\n"
          fi

          gh issue create \
            --title "ğŸ“± ç¤¾äº¤å†…å®¹å¾…å®¡æ ¸ - ${DATE}" \
            --body "$(echo -e "$BODY")" \
            --label "review-needed"
